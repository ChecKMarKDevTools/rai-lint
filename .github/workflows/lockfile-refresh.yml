name: Lockfile Refresh (release-please only)

on:
    workflow_run:
      workflows:
        - Release Please
      types:
        - completed
      branches:
        - release-please--*
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    refresh-npm-lockfiles:
        name: Refresh npm lockfiles
        runs-on: ubuntu-latest
        permissions:
            contents: write
        timeout-minutes: 8
        if: >
          (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
          ||
          (github.event_name == 'workflow_dispatch' && github.actor == 'anchildress1')

        steps:
            - name: Checkout head branch
              uses: actions/checkout@v6
              with:
                  ref: ${{ github.head_ref || github.ref_name }}

            - name: Get Node version from Volta
              id: node-version
              run: echo "version=$(jq -r '.volta.node' packages/node-commitlint/package.json)" >> "$GITHUB_OUTPUT"

            - name: Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ steps.node-version.outputs.version }}
                  cache: npm

            - name: Refresh npm lockfiles (root)
              run: npm install --ignore-scripts --package-lock-only

            - name: Auto-commit npm lockfiles
              uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
              with:
                  commit_message: "chore: refresh npm lockfiles"
                  file_pattern: package-lock.json
                  commit_user_name: github-actions[bot]
                  commit_user_email: github-actions[bot]@users.noreply.github.com
                  commit_author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>

    refresh-uv-lockfile:
        name: Refresh uv.lock
        runs-on: ubuntu-latest
        permissions:
            contents: write
        timeout-minutes: 8
        if: >
          (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
          ||
          (github.event_name == 'workflow_dispatch' && github.actor == 'anchildress1')

        steps:
            - name: Checkout head branch
              uses: actions/checkout@v6
              with:
                  ref: ${{ github.head_ref || github.ref_name }}

            - name: Setup Python
              uses: actions/setup-python@v6
              with:
                  python-version: "3.12"

            - name: Setup uv
              uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
              with:
                  enable-cache: true

            - name: Refresh uv lockfile
              working-directory: packages/python-gitlint
              run: uv lock

            - name: Auto-commit uv.lock
              uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
              with:
                  commit_message: "chore: refresh uv.lock"
                  file_pattern: packages/python-gitlint/uv.lock
                  commit_user_name: github-actions[bot]
                  commit_user_email: github-actions[bot]@users.noreply.github.com
                  commit_author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>

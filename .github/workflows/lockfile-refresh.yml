name: Lockfile Refresh (release-please only)

on:
    workflow_run:
      workflows:
        - Release Please
      types:
        - completed
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    resolve-release-please-branch:
        name: Resolve release-please branch
        runs-on: ubuntu-latest
        permissions:
            pull-requests: read
        timeout-minutes: 2
        outputs:
            ref: ${{ steps.release_branch.outputs.ref }}
        if: >
          (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
          ||
          (github.event_name == 'workflow_dispatch' && github.actor == 'anchildress1')

        steps:
            - name: Find open release-please branch
              id: release_branch
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  set -euo pipefail

                  api="https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls?state=open&per_page=100"
                  branches_json=$(curl -fsSL \
                    -H "Authorization: Bearer ${GH_TOKEN}" \
                    -H "Accept: application/vnd.github+json" \
                    -H "X-GitHub-Api-Version: 2022-11-28" \
                    "${api}" \
                    | jq -c '[.[] | select(.head.ref | startswith("release-please--")) | .head.ref] | unique')

                  count=$(echo "${branches_json}" | jq -r 'length')
                  if [ "${count}" = "0" ]; then
                    echo "No open release-please--* PR branches found; skipping lockfile refresh."
                    echo "ref=" >> "$GITHUB_OUTPUT"
                    exit 0
                  fi

                  if [ "${count}" != "1" ]; then
                    echo "Expected exactly 1 open release-please--* PR branch, found ${count}:" >&2
                    echo "${branches_json}" | jq -r '.[]' >&2
                    exit 1
                  fi

                  ref=$(echo "${branches_json}" | jq -r '.[0]')
                  echo "Found release-please branch: ${ref}"
                  echo "ref=${ref}" >> "$GITHUB_OUTPUT"

    refresh-npm-lockfiles:
        name: Refresh npm lockfiles
        runs-on: ubuntu-latest
        needs:
            - resolve-release-please-branch
        permissions:
            contents: write
        timeout-minutes: 4
        if: >
          (
            (
              (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
              ||
              (github.event_name == 'workflow_dispatch' && github.actor == 'anchildress1')
            )
            &&
            (needs.resolve-release-please-branch.outputs.ref != '')
          )

        steps:
            - name: Checkout release-please branch
              uses: actions/checkout@v6
              with:
                  ref: ${{ needs.resolve-release-please-branch.outputs.ref }}

            - name: Pull latest changes
              run: git pull

            - name: Echo checked-out branch
              run: |
                  set -euo pipefail
                  echo "Checked out: $(git rev-parse --abbrev-ref HEAD)"

            - name: Get Node version from Volta
              id: node-version
              run: echo "version=$(jq -r '.volta.node' packages/node-commitlint/package.json)" >> "$GITHUB_OUTPUT"

            - name: Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ steps.node-version.outputs.version }}
                  cache: npm

            - name: Refresh npm lockfiles (root)
              run: npm install --ignore-scripts --package-lock-only

            - name: Auto-commit npm lockfiles
              uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
              with:
                  commit_message: "chore: refresh npm lockfiles"
                  file_pattern: package-lock.json
                  commit_user_name: github-actions[bot]
                  commit_user_email: github-actions[bot]@users.noreply.github.com
                  commit_author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>

    refresh-uv-lockfile:
        name: Refresh uv.lock
        runs-on: ubuntu-latest
        needs:
            - resolve-release-please-branch
            - refresh-npm-lockfiles
        permissions:
            contents: write
        timeout-minutes: 4
        if: >
          (
            (
              (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
              ||
              (github.event_name == 'workflow_dispatch' && github.actor == 'anchildress1')
            )
            &&
            (needs.resolve-release-please-branch.outputs.ref != '')
          )

        steps:
            - name: Checkout release-please branch
              uses: actions/checkout@v6
              with:
                  ref: ${{ needs.resolve-release-please-branch.outputs.ref }}

            - name: Pull latest changes
              run: git pull

            - name: Echo checked-out branch
              run: |
                  set -euo pipefail
                  echo "Checked out: $(git rev-parse --abbrev-ref HEAD)"

            - name: Setup Python
              uses: actions/setup-python@v6
              with:
                  python-version: "3.12"

            - name: Setup uv
              uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
              with:
                  enable-cache: true

            - name: Refresh uv lockfile
              working-directory: packages/python-gitlint
              run: uv lock

            - name: Auto-commit uv.lock
              uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
              with:
                  commit_message: "chore: refresh uv.lock"
                  file_pattern: packages/python-gitlint/uv.lock
                  commit_user_name: github-actions[bot]
                  commit_user_email: github-actions[bot]@users.noreply.github.com
                  commit_author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>

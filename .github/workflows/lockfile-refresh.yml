name: Lockfile Refresh (release-please only)

on:
    pull_request:
        types: [opened, reopened, synchronize]
    push:
        branches:
            - main
            - "release-please--**"
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: write

jobs:
    refresh-npm-lockfiles:
        name: Refresh npm lockfiles
        runs-on: ubuntu-latest
        timeout-minutes: 8
        if: >
            (github.event_name == 'pull_request' &&
             startsWith(github.head_ref, 'release-please--') &&
             (github.event.pull_request.user.login == 'release-please[bot]' || github.event.pull_request.user.login == 'github-actions[bot]'))
            ||
            (github.event_name == 'push' &&
             (github.actor == 'release-please[bot]' || github.actor == 'github-actions[bot]') &&
             (startsWith(github.ref_name, 'release-please--') || github.ref_name == 'main'))
            ||
            (github.event_name == 'workflow_dispatch' &&
             (startsWith(github.ref_name, 'release-please--') || github.ref_name == 'main'))

        steps:
            - name: Checkout head branch
              uses: actions/checkout@v6
              with:
                  ref: ${{ github.head_ref || github.ref_name }}

            - name: Ensure jq is available
              run: |
                  command -v jq >/dev/null && exit 0
                  sudo apt-get update
                  sudo apt-get install -y jq

            - name: Get Node version from Volta
              id: node-version
              run: echo "version=$(jq -r '.volta.node' packages/node-commitlint/package.json)" >> "$GITHUB_OUTPUT"

            - name: Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ steps.node-version.outputs.version }}
                  cache: npm

            - name: Refresh npm lockfiles (root)
              run: npm install --ignore-scripts --package-lock-only

            - name: Auto-commit npm lockfiles
              uses: stefanzweifel/git-auto-commit-action@8621497c8c39c72f3e2a999a26b4ca1b5058a842 # v5.0.1
              with:
                  commit_message: "chore: refresh npm lockfiles"
                  file_pattern: "package-lock.json **/package-lock.json"
                  commit_user_name: "github-actions[bot]"
                  commit_user_email: "github-actions[bot]@users.noreply.github.com"
                  commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

    refresh-uv-lockfile:
        name: Refresh uv.lock
        runs-on: ubuntu-latest
        timeout-minutes: 8
        if: >
            (github.event_name == 'pull_request' &&
             startsWith(github.head_ref, 'release-please--') &&
             (github.event.pull_request.user.login == 'release-please[bot]' || github.event.pull_request.user.login == 'github-actions[bot]'))
            ||
            (github.event_name == 'push' &&
             (github.actor == 'release-please[bot]' || github.actor == 'github-actions[bot]') &&
             (startsWith(github.ref_name, 'release-please--') || github.ref_name == 'main'))
            ||
            (github.event_name == 'workflow_dispatch' &&
             (startsWith(github.ref_name, 'release-please--') || github.ref_name == 'main'))

        steps:
            - name: Checkout head branch
              uses: actions/checkout@v6
              with:
                  ref: ${{ github.head_ref || github.ref_name }}

            - name: Setup Python
              uses: actions/setup-python@v6
              with:
                  python-version: "3.12"

            - name: Setup uv
              uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
              with:
                  enable-cache: true

            - name: Refresh uv lockfile
              working-directory: packages/python-gitlint
              run: uv lock

            - name: Auto-commit uv.lock
              uses: stefanzweifel/git-auto-commit-action@8621497c8c39c72f3e2a999a26b4ca1b5058a842 # v5.0.1
              with:
                  commit_message: "chore: refresh uv.lock"
                  file_pattern: "packages/python-gitlint/uv.lock"
                  commit_user_name: "github-actions[bot]"
                  commit_user_email: "github-actions[bot]@users.noreply.github.com"
                  commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

name: Security Audit

on:
  schedule:
    - cron: "34 3 12,26 * *" # On the 12th and 26th of every month at 3:34 AM
  push:
    paths:
      - .github/workflows/security-audit.yml
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  scorecard:
    name: Scorecard
    runs-on: ubuntu-latest
    if: ${{ github.ref_type != 'tag' }}
    timeout-minutes: 12
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: "Checkout code"
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: "Run Trivy analysis"
        uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284 # v0.34.0
        with:
          scan-type: "repo"
          scan-ref: "."
          format: "sarif"
          output: "results.sarif"
          scanners: "misconfig,secret,license"
          severity: "HIGH,CRITICAL"
          ignore-unfixed: true

      - name: "Upload artifact"
        uses: actions/upload-artifact@v6
        with:
          name: SARIF file
          path: results.sarif
          retention-days: 30

      - name: "Upload to code-scanning"
        uses: github/codeql-action/upload-sarif@9e907b5e64f6b83e7804b09294d44122997950d6 # v4.32.3
        with:
          sarif_file: results.sarif

  license-scan:
    name: License Compliance
    runs-on: ubuntu-latest
    if: ${{ github.ref_type != 'tag' }}
    timeout-minutes: 7
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Get Node version from package.json
        id: node-version
        run: echo "version=$(jq -r '.engines.node' packages/node-commitlint/package.json)" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ steps.node-version.outputs.version }}

      - name: Install Node dependencies (locked)
        run: npm ci --ignore-scripts

      - name: Setup uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          python-version: "3.12"
          enable-cache: true

      - name: Install Python dependencies
        run: |
          uv sync --no-dev --directory packages/python-gitlint/

      - name: Check Node licenses
        run: |
          npx --yes license-checker --json --excludePrivatePackages --production --start packages/node-commitlint > node-licenses.json
          python3 .github/scripts/check-licenses.py node-licenses.json

      - name: Generate Python SBOM
        working-directory: packages/python-gitlint
        run: |
          mkdir -p reports
          uvx --from cyclonedx-bom==7.1.0 cyclonedx-py environment \
            .venv/bin/python3 \
            --mc-type library \
            --output-reproducible \
            --of JSON \
            -o reports/python-licenses.json

      - name: Check Python licenses
        run: |
          python3 .github/scripts/check-licenses.py packages/python-gitlint/reports/python-licenses.json


  # CodeQL analysis configured for javascript, python, and GitHub Actions workflows
  # Docs: https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#using-the-codeql-action
  codeql:
    name: CodeQL analysis
    runs-on: ubuntu-latest
    if: ${{ github.ref_type != 'tag' }}
    timeout-minutes: 10
    permissions:
      contents: read
      actions: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - language: javascript-typescript
            build-mode: none
          - language: python
            build-mode: none
          - language: actions
            build-mode: none
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: "Initialize CodeQL"
        uses: github/codeql-action/init@9e907b5e64f6b83e7804b09294d44122997950d6 # v4.32.3
        with:
          languages: ${{ matrix.language }}
          packs: codeql/actions-queries

      - name: "Build Node.js project"
        if: ${{ matrix.language == 'javascript-typescript' }}
        run: |
          npm ci --ignore-scripts
          npm run build --if-present

      - name: "Perform CodeQL Analysis"
        uses: github/codeql-action/analyze@9e907b5e64f6b83e7804b09294d44122997950d6 # v4.32.3

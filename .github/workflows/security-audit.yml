name: Security Audit

on:
  schedule:
    - cron: "03 2 * * 1" # Weekly on Monday at 2 AM
  push:
    paths:
      - ".github/workflows/security-audit.yml"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  scorecard:
    name: Scorecard
    runs-on: ubuntu-latest
    timeout-minutes: 12
    permissions:
      security-events: write
      id-token: write
      contents: read
      actions: read

    steps:
      - name: "Checkout code"
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: "Run Trivy analysis"
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: "repo"
          scan-ref: "."
          format: "sarif"
          output: "results.sarif"
          scanners: "misconfig,secret,license"
          severity: "HIGH,CRITICAL"
          ignore-unfixed: true

      - name: "Upload artifact"
        uses: actions/upload-artifact@v6
        with:
          name: SARIF file
          path: results.sarif
          retention-days: 60

      - name: "Upload to code-scanning"
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif

  license-scan:
    name: License Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 7
    steps:
      - uses: actions/checkout@v6

      - name: Get Node version from Volta
        id: node-version
        run: echo "version=$(jq -r '.volta.node' packages/node-commitlint/package.json)" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ steps.node-version.outputs.version }}

      - name: Install Node dependencies
        run: npm install --ignore-scripts

      - name: Setup uv
        uses: astral-sh/setup-uv@f94ec6bedd8674c4426838e6b50417d36b6ab231 # v5.3.1
        with:
          python-version: "3.12"
          enable-cache: true

      - name: Install Python dependencies
        run: |
          uv pip install -r <(uv pip compile packages/python-gitlint/pyproject.toml)

      - name: Check Node licenses
        run: |
          npx --yes license-checker --json --excludePrivatePackages > node-licenses.json
          python3 .github/scripts/check-licenses.py node-licenses.json

      - name: Check Python licenses
        run: >-
          uv pip install pip-licenses &&
          pip-licenses --format=json > python-licenses.json &&
          python3 .github/scripts/check-licenses.py python-licenses.json
